!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.EasyLazyLoad=t()}(this,function(){"use strict";var i=function(){var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){e=!0}});window.addEventListener("test",null,t)}catch(e){}return e}(),r={noop:function(){},arrayFrom:function(e){var t=e.length;if(!t||r.isArray(e))return e;for(var n=[],o=0;o<t;o++)n.push(e[o]);return n},forEach:function(e,t){var n=Array.prototype.forEach;if(n)return n.call(e,t);for(var o=0;o<e.length;o++)t(e[o],o)},getDataSet:function(e,t){return"dataset"in e?e.dataset[t]:e.getAttribute("data-"+t)},setDataSet:function(e,t,n){"dataset"in e?e.dataset[t]=n:e.setAttribute("data-"+t,n)},style:function(e,t){return"undefined"!=typeof getComputedStyle?getComputedStyle(e,null).getPropertyValue(t):e.style[t]},overflow:function(e){return r.style(e,"overflow")+r.style(e,"overflow-y")+r.style(e,"overflow-x")},isHTMLElement:function(e){return e instanceof HTMLElement},isArray:function(e){return e instanceof Array},scrollParent:function(e){if(!r.isHTMLElement(e))return window;for(var t=e;t&&t!==document.body&&t!==document.documentElement&&t.parentNode;){if(/(scroll|auto)/.test(r.overflow(t)))return t;t=t.parentNode}return window},loadImageAsync:function(e,t,n){t=t||r.noop,n=n||r.noop;var o=new Image;o.src=e,o.onload=function(){t({naturalHeight:o.naturalHeight,naturalWidth:o.naturalWidth,src:o.src})},o.onerror=function(e){n(e)}},throttle:function(o,i){var r=null,a=0;return function(){if(!r){var e=Date.now()-a,t=arguments,n=function(){a=Date.now(),r=!1,o.apply(null,t)};e<i?r=setTimeout(n,i):n()}}},findIndex:function(e,t){var n,o;for(n=0,o=e.length;n<o&&!t(e[n]);n++);return n},addEvent:function(e,t,n,o){r.isUndef(o),"function"==typeof e.addEventListener?e.addEventListener(t,n,i?{capture:o,passive:!0}:o):"function"==typeof e.attachEvent&&e.attachEvent("on"+t,n)},removeEvent:function(e,t,n){"function"==typeof e.removeEventListener?e.removeEventListener(t,n):"function"==typeof e.detatchEvent&&e.detatchEvent("on"+t,n)},isUndef:function(e){return null==e}},a=function(e,t,n){this.el=e,this.src=r.getDataSet(e,"src"),this.options=t,this.rect=null,this.loading=!1,this.loaded=!1,this.loadInstance=n};a.prototype.render=function(e,t){this.el.setAttribute("src",t||this.options[e])},a.prototype.load=function(){var t=this;if(!t.loading&&!t.loaded)if(t.loading=!0,t.loadInstance.loadMoreMode){t.loadInstance.options.onLoadMore(function(){t.loading=!1})}else r.loadImageAsync(this.src,function(e){t.loadInstance.options.beforeMount&&(t.loadInstance._callHook("beforeMount",t.el),console.log(t.el.offsetTop)),t.render("success",e.src),t.loadInstance.options.mounted&&t.loadInstance._callHook("mounted",t.el),t.finishLoading()},function(){t.render("error"),t.finishLoading()})},a.prototype.finishLoading=function(){var t=this;t.loading=!1,t.loaded=!0;var e=t.loadInstance.imageListeners,n=r.findIndex(e,function(e){return r.getDataSet(e.el,"id")===r.getDataSet(t.el,"id")});e.splice(n,1),t.loadInstance._observer&&t.loadInstance._observer.unobserve(t.el)},a.prototype.getRect=function(){this.rect=this.el.getBoundingClientRect()},a.prototype.checkInView=function(){return this.getRect(),this.rect.top<window.innerHeight*this.options.preLoad&&this.rect.left<window.innerWidth*this.options.preLoad&&0<this.rect.right};var t="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",o=["scroll","wheel","mousewheel","resize","animationend","transitionend","touchmove"],e=!!window.IntersectionObserver,n=function(e,t){this._initOptions(t),this._initProperties(e,t),this._preLoad(),this._initImageListeners(),this._initEvents()};n.prototype._initOptions=function(e){this.options={loading:(e=e||{}).loading||t,error:e.error||t,throttleWait:e.throttleWait||100,listenEvents:e.listenEvents||o,preLoad:e.preLoad||1.3,observer:!!r.isUndef(e.observer)||e.observer,onPreLoad:e.onPreLoad||r.noop,beforeMount:e.beforeMount,mounted:e.mounted,onLoadMore:e.onLoadMore}},n.prototype._initProperties=function(e,t){if(this.loadMoreMode=!r.isUndef(this.options.onLoadMore),this.el=r.isHTMLElement(e)?e:document.querySelector(e),!this.el){if(this.loadMoreMode)throw Error("loadMore should bind a mounted dom");this.el=document.body}this.imageListeners=[],this.imageListenersMap={},this.lazyloadHandler=null,this._eventBindEl=null,this._eventBindElRect=null},n.prototype._preLoad=function(){if(!this.loadMoreMode){var e=this,t=e.options.error;r.loadImageAsync(e.options.loading,function(){e._callHook("onPreLoad")}),r.loadImageAsync(t)}};var s=0;return n.prototype._initImageListeners=function(){var o=this,e=this.loadMoreMode?[o.el]:o.el.querySelectorAll("img");if(e&&e.length){var t=r.arrayFrom(e);r.forEach(t,function(e){if(r.getDataSet(e,"src")&&!o.imageListenersMap[r.getDataSet(e,"id")]||o.loadMoreMode){var t=new a(e,o.options,o);o.loadMoreMode||t.render("loading");var n=++s;r.setDataSet(e,"id",n),o.imageListeners.push(t),o.imageListenersMap[n]=t}})}},n.prototype._initEvents=function(){e&&this.options.observer?this._initIntersectionObserver():this._initNormalEvents()},n.prototype._initIntersectionObserver=function(){var t=this;t._observer=new IntersectionObserver(t._observerHandler.bind(t),{rootMargin:window.innerHeight*(t.options.preLoad-1)+"px "+window.innerWidth*(t.options.preLoad-1)+"px"}),r.forEach(t.imageListeners,function(e){t._observer.observe(e.el)})},n.prototype._observerHandler=function(e,t){var n=this;r.forEach(e,function(e){if(r.isUndef(e.isIntersecting)?e.intersectionRatio:e.isIntersecting){var t=r.getDataSet(e.target,"id");n.imageListenersMap[t].load()}})},n.prototype._initNormalEvents=function(){var t=this;t.lazyloadHandler=r.throttle(this._lazyloadHandler.bind(this),this.options.throttleWait);var n=r.scrollParent(t.el);r.forEach(o,function(e){r.addEvent(n,e,t.lazyloadHandler)}),t._eventBindEl=n,t._eventBindElRect=r.isHTMLElement(n)?n.getBoundingClientRect():document.body.getBoundingClientRect(),t.lazyloadHandler()},n.prototype._lazyloadHandler=function(){r.forEach(this.imageListeners,function(e){e.checkInView()&&e.load()})},n.prototype._callHook=function(e){var t=this.options[e],n=r.arrayFrom(arguments);t.apply(null,n.slice(1))},n.prototype.destroy=function(){var t=this;t._observer?t._observer.disconnect():r.forEach(o,function(e){r.removeEvent(t._eventBindEl,e,t.lazyloadHandler)})},n.prototype.refresh=function(){this._initImageListeners(),this._initEvents()},n});
